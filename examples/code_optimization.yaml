id: code-optimization
name: Code Optimization Pipeline
description: Analyze and optimize code for performance and best practices

parameters:
  code_file:
    type: string
    required: true
    description: Path to the code file to optimize
  language:
    type: string
    default: python
    description: Programming language

steps:
  - id: read_code
    tool: filesystem
    action: read
    parameters:
      path: "{{code_file}}"
  
  - id: analyze_code
    action: analyze_text
    parameters:
      text: |
        Analyze this {{language}} code for optimization opportunities:
        
        ```{{language}}
        {{read_code.content}}
        ```
        
        Identify:
        1. Performance bottlenecks
        2. Code quality issues
        3. Best practice violations
      model: <AUTO>Select model best suited for code analysis</AUTO>
      model: <AUTO task="analyze">Select model best suited for code analysis</AUTO>
      analysis_type: "code_quality"
    dependencies:
      - read_code
  
  - id: optimize_code
    action: generate_text
    parameters:
      prompt: |
        Based on this analysis:
        {{analyze_code.result}}
        
        Provide optimized version of the code that addresses the identified issues.
        Return only the optimized code, no explanations.
      model: <AUTO>Select model for code generation</AUTO>
      model: <AUTO task="generate">Select model for code generation</AUTO>
      max_tokens: 2000
    dependencies:
      - analyze_code
  
  - id: save_optimized_code
    tool: filesystem
    action: write
    parameters:
      path: "examples/outputs/code_optimization/optimized_{{code_file | basename}}"
      content: "{{optimize_code.result}}"
    dependencies:
      - optimize_code
  
  - id: save_analysis_report
    tool: filesystem
    action: write
    parameters:
      path: "examples/outputs/code_optimization/code_optimization_report_{{ execution.timestamp | slugify }}.md"
      content: |
        # Code Optimization Report
        
        **File:** {{code_file}}
        **Language:** {{language}}
        **Date:** {{ now() }}
        
        ## Analysis Results
        
        {{analyze_code.result}}
        
        ## Optimization Summary
        
        The optimized code has been saved to: examples/outputs/code_optimization/optimized_{{code_file | basename}}
    dependencies:
      - analyze_code
      - optimize_code

outputs:
  analysis: "{{analyze_code.result}}"
  optimized_code: "{{optimize_code.result}}"
  optimized_file: "optimized_{{code_file | basename}}"
  report_file: "{{save_analysis_report.filepath}}"