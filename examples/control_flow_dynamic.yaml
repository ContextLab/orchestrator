id: control-flow-dynamic
# Dynamic Flow Control Example
# Demonstrates goto and dynamic dependencies with AUTO resolution
name: Error Handling Pipeline
description: Dynamic flow control based on error conditions
version: "1.0.0"

parameters:
  operation:
    type: string
    description: Operation to perform
  retry_limit:
    type: integer
    default: 3

steps:
  # Initial validation
  - id: validate_input
    tool: validation
    action: validate
    parameters:
      data: "{{ operation }}"
      validation_type: "operation_check"
      
  # Determine operation risk level
  - id: assess_risk
    tool: task-delegation
    action: delegate
    parameters:
      task: "<AUTO>Assess the risk level of operation '{{ operation }}': low, medium, or high</AUTO>"
    depends_on: [validate_input]
    
  # Dynamic dependency based on risk
  - id: prepare_operation
    tool: data-processing
    action: process
    parameters:
      operation: prepare
      data: "{{ operation }}"
      safety_level: "{{ assess_risk.result }}"
    depends_on: <AUTO>Based on risk level {{ assess_risk.result }}, should we depend on 'validate_input' only or also add 'safety_check'?</AUTO>
    
  # Optional safety check (created dynamically)
  - id: safety_check
    tool: validation
    action: validate
    if: "{{ assess_risk.result == 'high' }}"
    parameters:
      validation_type: "safety"
      data: "{{ operation }}"
    depends_on: [assess_risk]
    
  # Execute operation
  - id: execute_operation
    tool: terminal
    action: execute
    parameters:
      command: "{{ operation }}"
    depends_on: [prepare_operation]
    
  # Check execution result
  - id: check_result
    tool: validation
    action: validate
    parameters:
      data: "{{ execute_operation.result }}"
      validation_type: "result_check"
    depends_on: [execute_operation]
    
  # Dynamic flow control based on result
  - id: handle_result
    tool: task-delegation
    action: delegate
    parameters:
      task: "Process execution result"
      context: "{{ check_result.result }}"
    goto: "<AUTO>Based on execution result {{ check_result.result }}, which handler should we jump to: 'success_handler', 'retry_handler', or 'failure_handler'?</AUTO>"
    depends_on: [check_result]
    
  # Retry handler
  - id: retry_handler
    tool: data-processing
    action: process
    parameters:
      operation: prepare_retry
      data: |
        {
          "attempt": {{ (metadata.retry_count | default(0)) + 1 }},
          "max_attempts": {{ retry_limit }}
        }
    goto: "{{ metadata.retry_count < retry_limit ? 'execute_operation' : 'failure_handler' }}"
    
  # Success handler
  - id: success_handler
    tool: report-generator
    action: generate
    parameters:
      title: "Operation Successful"
      content: |
        ## Success Report
        - Operation: {{ operation }}
        - Risk Level: {{ assess_risk.result }}
        - Execution Time: {{ execute_operation.execution_time }}
        - Result: {{ execute_operation.result }}
    goto: "cleanup"
    
  # Failure handler
  - id: failure_handler
    tool: report-generator
    action: generate
    parameters:
      title: "Operation Failed"
      content: |
        ## Failure Report
        - Operation: {{ operation }}
        - Risk Level: {{ assess_risk.result }}
        - Error: {{ check_result.error | default('Unknown error') }}
        - Retry Attempts: {{ metadata.retry_count | default(0) }}
    goto: "cleanup"
    
  # Cleanup (always executed)
  - id: cleanup
    tool: data-processing
    action: process
    parameters:
      operation: cleanup
      data: |
        {
          "operation_id": "{{ execute_operation.id }}",
          "status": "{{ check_result.result.status }}"
        }
      
  # Save final report
  - id: save_report
    tool: filesystem
    action: write
    parameters:
      path: "examples/outputs/control_flow_dynamic/execution_report_{{ execution.timestamp | slugify }}.md"
      content: |
        # Dynamic Flow Control Execution Report
        
        **Date:** {{ execution.timestamp }}
        **Operation:** {{ operation }}
        **Risk Level:** {{ assess_risk.result }}
        
        ## Execution Summary
        
        - Status: {{ check_result.result.status | default('Unknown') }}
        - Retry Attempts: {{ metadata.retry_count | default(0) }}
        - Execution Time: {{ execute_operation.execution_time | default('N/A') }}
        
        ## Report Details
        
        {{ success_handler.report | default(failure_handler.report) | default('No report generated') }}
        
        ---
        *Generated by Dynamic Flow Control Pipeline*
    depends_on: [cleanup]

outputs:
  operation_status: "{{ check_result.result.status }}"
  risk_level: "{{ assess_risk.result }}"
  retry_count: "{{ metadata.retry_count | default(0) }}"
  final_report: "{{ success_handler.report or failure_handler.report }}"