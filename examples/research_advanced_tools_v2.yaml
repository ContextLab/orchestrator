# Research Pipeline with Advanced Tools (Fixed Version)
# Uses specialized tools: web-search, headless-browser, report-generator, pdf-compiler
id: research_advanced_tools_v2
name: Research Pipeline with Advanced Tools (Fixed)
description: Advanced research pipeline with improved error handling and data passing
version: "2.0.0"

parameters:
  topic:
    type: string
    default: "quantum computing applications"
  max_results:
    type: integer
    default: 10

steps:
  - id: search_topic
    tool: web-search
    action: search
    parameters:
      query: "{{ topic }} latest developments 2024 2025"
      max_results: "{{ max_results }}"
      backend: "duckduckgo"
    
  - id: analyze_results
    action: analyze_text
    parameters:
      text: |
        Topic: {{ topic }}
        
        Search Results:
        {% for result in search_topic.results %}
        {{ loop.index }}. {{ result.title }}
           URL: {{ result.url }}
           Snippet: {{ result.snippet }}
        {% endfor %}
      prompt: |
        Analyze these search results and identify:
        1. The most credible and relevant sources (top 3-5)
        2. Key themes and developments
        3. Any notable trends or breakthroughs
        
        Format as a structured analysis.
      model: <AUTO task="analyze">Select model for analysis</AUTO>
    dependencies:
      - search_topic
    
  - id: extract_content
    tool: headless-browser
    action: scrape
    parameters:
      url: "{{ search_topic.results[0].url }}"
    dependencies:
      - search_topic
    condition: "{{ search_topic.results | length > 0 }}"
    continue_on_error: true  # Continue if scraping fails
    
  - id: generate_summary
    action: generate_text
    parameters:
      prompt: |
        Create an executive summary for a research report on "{{ topic }}" based on:
        
        Analysis:
        {{ analyze_results.result }}
        
        {% if extract_content.success %}
        Primary Source Content:
        {{ extract_content.content | truncate(1000) }}
        {% else %}
        Note: Unable to extract content from primary source.
        {% endif %}
        
        Requirements:
        - Length: 200-300 words
        - Professional, informative tone
        - Focus on latest developments and applications
        - Include specific examples where available
      model: <AUTO task="generate">Select model for summary</AUTO>
      max_tokens: 400
    dependencies:
      - analyze_results
      - extract_content
    
  - id: generate_report
    tool: report-generator
    action: generate
    parameters:
      title: "Research Report: {{ topic }}"
      query: "{{ topic }}"
      context: "Latest developments and applications in 2024-2025"
      search_results: "{{ search_topic }}"  # Pass the entire search result object
      extraction_results: "{{ extract_content | default({}) }}"
      findings:
        - "Found relevant sources on {{ topic }}"
        - "Primary focus on applications and latest developments"
        - "Analysis includes web search results and content extraction"
      recommendations:
        - "Monitor emerging trends in {{ topic }}"
        - "Focus on practical applications and case studies"
        - "Track regulatory and policy developments"
      quality_score: 0.80
    dependencies:
      - search_topic
      - analyze_results
      - generate_summary
    
  - id: save_report
    tool: filesystem
    action: write
    parameters:
      path: "examples/outputs/research_advanced_tools/research_{{ topic | slugify }}.md"
      content: |
        {{ generate_report.markdown }}
        
        ## Additional Analysis
        
        {{ analyze_results.result }}
        
        ## Executive Summary
        
        {{ generate_summary.result }}
        
        ---
        *Report generated by Advanced Research Pipeline v2.0*
    dependencies:
      - generate_report
    
  - id: compile_pdf
    tool: pdf-compiler
    action: compile
    parameters:
      markdown_content: "{{ save_report.content | default(generate_report.markdown) }}"
      output_path: "examples/outputs/research_advanced_tools/research_{{ topic | slugify }}.pdf"
      title: "Research Report: {{ topic }}"
      author: "AI Research Assistant"
      install_if_missing: true
    dependencies:
      - save_report
    condition: "{{ compile_to_pdf | default(false) }}"
    continue_on_error: true  # PDF compilation is optional

outputs:
  report_file: "{{ save_report.filepath }}"
  search_count: "{{ search_topic.total_results }}"
  quality_score: 0.80
  summary: "{{ generate_summary.result }}"