id: control-flow-advanced
# Advanced Control Flow Example
# Combines conditionals and loops in a practical scenario
name: Multi-Stage Text Processing
description: Process text through multiple stages with conditional paths
version: "1.0.0"

parameters:
  input_text:
    type: string
    description: Text to process
    default: "This is a sample text for processing."
  languages:
    type: array
    default: ["es", "fr", "de"]
    description: Languages to translate to
  quality_threshold:
    type: number
    default: 0.7
    description: Quality threshold for translations
    
steps:
  # Initial analysis
  - id: analyze_text
    action: analyze_text
    parameters:
      text: "{{ input_text }}"
      model: <AUTO task="analyze">Select a model for text analysis</AUTO>
      analysis_type: "comprehensive"
      
  # Determine if text needs enhancement
  - id: check_quality
    action: generate_text
    parameters:
      prompt: "Text quality analysis complete. The analysis shows: {{ analyze_text.result }}"
      model: <AUTO task="summarize">Select a model for summary</AUTO>
      max_tokens: 50
    dependencies:
      - analyze_text
      
  # Conditional enhancement
  - id: enhance_text
    action: generate_text
    if: "{{ analyze_text.result contains 'improve' }}"
    parameters:
      prompt: |
        Improve the following text based on this analysis:
        Analysis: {{ analyze_text.result }}
        
        Text: {{ input_text }}
      model: <AUTO task="generate">Select a model for text improvement</AUTO>
      max_tokens: 500
    dependencies:
      - check_quality
      
  # Use enhanced or original text
  - id: prepare_text
    action: generate_text
    parameters:
      prompt: "Preparing text for translation. Using {% if enhance_text.result %}enhanced{% else %}original{% endif %} text."
      model: <AUTO task="summarize">Select a model for status update</AUTO>
      max_tokens: 50
    dependencies:
      - enhance_text
      - check_quality
      
  # Translate to multiple languages
  - id: translate_text
    for_each: "{{ languages }}"
    max_parallel: 2
    steps:
      # Translate
      - id: translate
        action: generate_text
        parameters:
          prompt: |
            Translate the following text to {{ $item }}:
            
            {{ enhance_text.result | default(input_text) }}
          model: <AUTO task="translate">Select a model for translation to {{ $item }}</AUTO>
          max_tokens: 600
          
      # Validate translation quality
      - id: validate_translation
        action: analyze_text
        parameters:
          text: "{{ translate.result }}"
          model: <AUTO task="analyze">Select a model for quality assessment</AUTO>
          analysis_type: "quality"
        dependencies:
          - translate
          
      # Save if quality is good
      - id: save_translation
        tool: filesystem
        action: write
        if: "{{ validate_translation.result contains 'good' or validate_translation.result contains 'excellent' }}"
        parameters:
          path: "examples/outputs/control_flow_advanced/translations/{{ $item }}_translation.txt"
          content: |
            # Translation to {{ $item }}
            
            ## Original Text
            {{ enhance_text.result | default(input_text) }}
            
            ## Translated Text
            {{ translate.result }}
            
            ## Quality Assessment
            {{ validate_translation.result }}
        dependencies:
          - validate_translation
    dependencies:
      - prepare_text
      
  # Create final report
  - id: create_report
    tool: filesystem
    action: write
    parameters:
      path: "examples/outputs/control_flow_advanced/final_report.md"
      content: |
        # Multi-Stage Text Processing Report
        
        ## Original Text
        {{ input_text }}
        
        ## Analysis
        {{ analyze_text.result }}
        
        ## Enhancement
        {{ enhance_text.result ? 'Text was enhanced' : 'Original text was used' }}
        
        ## Translations
        Attempted translations to: {{ languages | join(', ') }}
        
        Check the examples/outputs/control_flow_advanced/translations/ directory for successful translations.
    dependencies:
      - translate_text
      
outputs:
  analysis: "{{ analyze_text.result }}"
  enhanced: "{{ enhance_text.result | default('N/A') }}"
  report_file: "{{ create_report.filepath }}"