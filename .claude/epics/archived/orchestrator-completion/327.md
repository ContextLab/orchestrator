---
name: YAML Specification Enhancement
status: backlog
created: 2025-09-01T19:11:07Z
updated: 2025-09-01T19:27:16Z
epic: orchestrator-completion
size: L
parallel: true
dependencies: [324]
estimate: 5-8 days
---

# YAML Specification Enhancement

## Overview

Implement missing expert assignments, selection schema, personalities, and control flow from issue #307 to achieve complete YAML specification compliance. This task extends the existing YAMLCompiler to support expert definitions, selection schema, personality system prompts, and advanced control flow constructs that transform the orchestrator from basic pipeline execution to sophisticated AI workflow orchestration.

## Technical Scope

**Core Focus**: Extend YAMLCompiler for expert definitions, selection schema, personality system prompts, advanced control flow

**Primary Files**:
- `src/orchestrator/api/core.py` - YAMLCompiler enhancements
- `src/orchestrator/execution/engine.py` - Control flow execution logic
- `src/orchestrator/models/provider.py` - Expert assignment integration
- `src/orchestrator/models/selection.py` - Selection schema implementation

**Architecture**: Enhance existing YAML parsing infrastructure without disrupting current AUTO tag and basic compilation functionality

## Issue #307 Compliance Requirements

### 1. Expert Assignments
```yaml
experts:
  analyst: 
    model: gpt-4o
    provider: openai
    temperature: 0.1
  creative:
    model: claude-3-5-sonnet-20241022
    provider: anthropic
    temperature: 0.7
  
steps:
  - name: analysis
    expert: analyst  # References expert definition
    prompt: "Analyze this data..."
```

### 2. Selection Schema
```yaml
selection:
  strategy: cost  # cost, performance, balanced
  fallback: gpt-4o-mini
  timeout: 30s
  
steps:
  - name: flexible_step
    selection: performance  # Override global strategy
    prompt: "Process this..."
```

### 3. Personality System Prompts
```yaml
personalities:
  technical_writer:
    system_prompt: "You are a technical documentation expert..."
    style: concise
    format: markdown
  data_scientist:
    system_prompt: "You are a data analysis expert..."
    style: analytical
    format: structured

steps:
  - name: documentation
    personality: technical_writer
    prompt: "Document this analysis..."
```

### 4. Advanced Control Flow
```yaml
steps:
  - name: validation
    prompt: "Validate input data..."
    condition: "{{input_data}} is not empty"
    on_false: skip_to_error_handling
    on_failure: retry_validation
    on_success: continue_processing
    
  - name: retry_validation
    prompt: "Retry validation with relaxed criteria..."
    max_retries: 3
```

## Current State Analysis

### Existing YAML Compiler Strengths
- Robust YAML parsing with pydantic validation
- AUTO tag resolution system for dynamic model selection
- Clean pipeline compilation to StateGraph execution format
- Comprehensive error handling and validation

### Missing Components from #307
1. **Expert Definitions**: No support for named expert configurations
2. **Selection Schema**: Limited to AUTO tags, no strategy-based selection
3. **Personality Integration**: No system prompt management beyond basic prompts
4. **Control Flow**: Basic sequential execution, missing conditional logic
5. **Product File Generation**: No support for structured output generation

## Implementation Strategy

### Phase 1: Expert Assignment System (Days 1-2)

**YAMLCompiler Enhancement**:
```python
class ExpertDefinition(BaseModel):
    model: str
    provider: str
    temperature: float = 0.7
    max_tokens: Optional[int] = None
    system_prompt: Optional[str] = None

class PipelineSpec(BaseModel):
    experts: Optional[Dict[str, ExpertDefinition]] = {}
    # ... existing fields
```

**Integration Points**:
- Extend step compilation to resolve expert references
- Connect to existing model provider selection logic
- Add expert validation during compilation phase

### Phase 2: Selection Schema Implementation (Days 2-3)

**Selection Strategy Extension**:
```python
class SelectionStrategy(str, Enum):
    COST = "cost"
    PERFORMANCE = "performance" 
    BALANCED = "balanced"

class SelectionSchema(BaseModel):
    strategy: SelectionStrategy = SelectionStrategy.BALANCED
    fallback: str = "gpt-4o-mini"
    timeout: int = 30
```

**Provider Integration**:
- Extend existing provider selection logic
- Add cost/performance metadata to model registry
- Implement fallback mechanism for failed selections

### Phase 3: Personality System Prompts (Days 3-4)

**Personality Management**:
```python
class PersonalityDefinition(BaseModel):
    system_prompt: str
    style: Optional[str] = None
    format: Optional[str] = None
    parameters: Dict[str, Any] = {}

class PersonalityManager:
    """Manages personality definitions and system prompt injection"""
    
    def resolve_personality(self, name: str) -> PersonalityDefinition:
        """Resolve personality by name with validation"""
        
    def inject_system_prompt(self, step: StepDefinition, personality: PersonalityDefinition) -> str:
        """Combine step prompt with personality system prompt"""
```

### Phase 4: Advanced Control Flow (Days 4-6)

**Control Flow Extensions**:
```python
class ControlFlowDefinition(BaseModel):
    condition: Optional[str] = None
    on_false: Optional[str] = None  # Step name to jump to
    on_failure: Optional[str] = None
    on_success: Optional[str] = None
    max_retries: int = 1

class ConditionalExecution:
    """Handles conditional logic evaluation and flow control"""
    
    def evaluate_condition(self, condition: str, context: ExecutionState) -> bool:
        """Evaluate condition expression against current context"""
        
    def resolve_flow_target(self, target: str, pipeline: Pipeline) -> int:
        """Resolve flow control target to step index"""
```

**StateGraph Integration**:
- Extend StateGraph node creation with conditional routing
- Add retry mechanism integration to existing error handling
- Implement jump-to-step functionality

### Phase 5: Product File Generation (Days 6-8)

**Output Generation System**:
```python
class ProductFileDefinition(BaseModel):
    name: str
    format: str  # json, yaml, markdown, txt
    template: Optional[str] = None
    variables: List[str] = []

class ProductFileManager:
    """Manages structured output generation"""
    
    def generate_product_file(self, definition: ProductFileDefinition, 
                            context: ExecutionState) -> Path:
        """Generate structured output file from execution results"""
```

## Integration Requirements

### Model Provider Enhancement
- Extend existing provider abstractions to support expert assignments
- Add cost/performance metadata for selection strategies
- Integrate personality system prompts into model calls

### Execution Engine Updates
- Enhance StateGraph node creation for control flow routing
- Add conditional evaluation capability to step execution
- Integrate retry mechanisms with existing error handling

### Variable Management Integration
- Extend variable resolution to support condition evaluation
- Add product file variable extraction and formatting
- Maintain backward compatibility with existing variable system

## Testing Strategy

### Unit Tests
- Expert assignment resolution and validation
- Selection strategy implementation with cost/performance data
- Personality system prompt injection and formatting
- Control flow condition evaluation and routing
- Product file generation with various formats

### Integration Tests
- End-to-end pipeline compilation with all #307 features
- Real execution with expert assignments and control flow
- Error handling across all new components
- Backward compatibility with existing pipeline definitions

### Compliance Tests
```python
def test_issue_307_expert_assignments():
    """Test expert assignment feature from #307"""
    yaml_content = """
    experts:
      analyst: {model: gpt-4o, provider: openai, temperature: 0.1}
    steps:
      - name: analysis
        expert: analyst
        prompt: "Analyze this data"
    """
    # Verify expert resolution and model assignment
    
def test_issue_307_selection_schema():
    """Test selection strategy feature from #307"""
    # Test cost, performance, balanced strategies
    
def test_issue_307_personalities():
    """Test personality system prompt feature from #307"""
    # Test system prompt injection and management
    
def test_issue_307_control_flow():
    """Test advanced control flow from #307"""
    # Test conditional execution, retries, flow control
```

## Acceptance Criteria

### Functional Requirements
- [ ] Expert assignments: Define and reference named expert configurations
- [ ] Selection schema: Cost/performance/balanced strategy selection with fallback
- [ ] Personality system: Named personality definitions with system prompt injection  
- [ ] Control flow: Conditional execution with on_false/on_failure/on_success routing
- [ ] Product files: Structured output generation from execution results
- [ ] Backward compatibility: All existing pipelines continue to work unchanged

### Technical Requirements
- [ ] YAML parsing: All #307 features parse correctly with validation
- [ ] Compilation: New features compile to executable StateGraph format
- [ ] Execution: Real execution supports all new control flow constructs
- [ ] Error handling: Comprehensive error messages for malformed specifications
- [ ] Performance: No regression in existing pipeline compilation/execution times

### Quality Requirements
- [ ] Documentation: Comprehensive documentation for all new YAML features
- [ ] Test coverage: >90% coverage for all new components
- [ ] Integration: Seamless integration with existing execution engine
- [ ] Validation: Robust input validation with clear error messages
- [ ] Examples: Working examples demonstrating all #307 features

## Definition of Done

- All #307 YAML specification features implemented and tested
- Comprehensive unit and integration test suite with >90% coverage
- Real execution engine supports all new control flow constructs
- Expert assignments integrate with existing model provider system
- Selection strategies work with cost/performance/balanced logic
- Personality system prompts inject correctly into model calls
- Product file generation creates structured outputs as specified
- Backward compatibility maintained with existing pipeline definitions
- Documentation updated with examples of all new features
- Performance benchmarks show no regression in existing functionality

## Risk Assessment

**Technical Risks**:
- Control flow complexity may require significant StateGraph modifications
- Personality system prompt injection needs careful prompt engineering
- Selection strategy requires accurate cost/performance model metadata

**Mitigation Strategies**:
- Incremental implementation with extensive testing at each phase
- Leverage existing StateGraph conditional routing capabilities where possible
- Start with simple system prompt injection before advanced personality features
- Use existing model registry as foundation for cost/performance data

**Dependencies**:
- Requires Task 324 (Real Step Execution Engine) for testing advanced control flow
- Benefits from enhanced model provider system for expert assignments
- Integrates with existing variable management for condition evaluation
